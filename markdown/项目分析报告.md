# 项目分析报告：TinyMLPT 开发板系统

## 1. 项目概述

TinyMLPT（Tiny Machine Learning Platform）是一个基于STM32H747I-Discovery开发板的嵌入式机器学习平台。该项目旨在构建一个集成多种传感器、支持神经网络推理的边缘计算平台，为TinyML应用提供硬件基础和软件开发框架。

### 1.1 项目背景

随着物联网和边缘计算的发展，在资源受限设备上运行机器学习算法的需求日益增长。TinyMLPT项目通过充分利用STM32H7系列高性能双核处理器的优势，实现了在嵌入式设备上进行实时数据采集、处理和智能分析的能力。

### 1.2 主要功能与目标

- 高性能双核处理架构（Cortex-M7 + Cortex-M4）
- 丰富的传感器接口支持（摄像头、麦克风）
- 扩展存储能力（SDRAM、QSPI Flash）
- 无线通信功能（WiFi）
- 支持CMSIS-NN神经网络推理加速
- 实时数据采集与处理

## 2. 硬件架构分析

### 2.1 核心处理器

项目采用STM32H747I-Discovery开发板，该开发板基于STM32H747XIH6微控制器，具有以下特点：

- 双核架构：Cortex-M7（主频480MHz）+ Cortex-M4（主频240MHz）
- 丰富的内存资源：1MB Flash，1MB SRAM，16KB DTCM，64KB ITCM
- 高性能外设：FMC、QSPI、DCMI、SAI等
- 支持多种通信接口：USART、I2C、SPI等

### 2.2 扩展硬件模块

| 模块名称 | 型号 | 用途 | 接口 | 实现文件 |
|---------|------|------|------|----------|
| 扩展SDRAM | 32MB | 扩展内存，用于图像处理和模型存储 | FMC | sdram_fmc_drv.c |
| QSPI Flash | W25Q256 | 外部存储，用于存储模型和数据 | QSPI | qspi_flash_drv.c |
| 摄像头 | OV2640 | 图像采集 | DCMI + I2C | ov2640_dcmi_drv.c |
| 麦克风 | MP34DT06JTR | 音频采集 | SAI | microphone_sai_drv.c |
| WiFi模块 | - | 无线通信 | UART4 | 集成在main.c中 |

### 2.3 硬件连接示意图

```
STM32H747I-Discovery
      │
      ├── Cortex-M7 (480MHz) - 主要处理核心
      │   │
      │   ├── FMC ──────────── SDRAM (32MB, 0xC0000000)
      │   ├── QSPI ─────────── QSPI Flash (W25Q256)
      │   ├── DCMI ─────────── OV2640摄像头
      │   ├── SAI ──────────── MP34DT06JTR麦克风
      │   └── USART1 ───────── 调试串口
      │
      └── Cortex-M4 (240MHz) - 辅助处理核心
          │
          └── USART3 ───────── 与Raspberry Pi Pico通信
```

## 3. 软件架构分析

### 3.1 总体架构

项目采用分层架构设计，包括以下几层：

1. **硬件抽象层**：BSP（Board Support Package）提供对开发板硬件的抽象
2. **驱动层**：各外设的驱动实现
3. **功能模块层**：各种功能模块（内存测试、通信、传感器等）
4. **应用层**：主程序逻辑和测试应用

### 3.2 目录结构

```
SelfBoardProject/
├── BSP/                    # 板级支持包
│   ├── Components/         # 组件驱动
│   ├── STM32H747I-Discovery/  # 开发板支持
│   └── Utilities/          # 工具函数
├── CM4/                    # Cortex-M4核心代码
│   └── Core/               # M4核心主代码
├── CM7/                    # Cortex-M7核心代码
│   └── Core/               # M7核心主代码
├── Common/                 # 公共代码
├── Drivers/                # 官方驱动库
│   ├── CMSIS/              # CMSIS核心和DSP库
│   └── STM32H7xx_HAL_Driver/ # HAL驱动
├── MDK-ARM/                # Keil项目文件
│   ├── TinyMLPT.uvprojx    # 主项目文件
│   ├── sdram_fmc_drv.c     # SDRAM驱动
│   ├── qspi_flash_drv.c    # QSPI Flash驱动
│   ├── ov2640_dcmi_drv.c   # 摄像头驱动
│   └── microphone_sai_drv.c # 麦克风驱动
├── PythonTestCode/         # Python测试代码
└── TinyMLPT.ioc            # CubeMX配置文件
```

### 3.3 双核通信机制

项目中Cortex-M7和Cortex-M4核心通过硬件信号量（HSEM）进行同步：

```c
/*HW semaphore Clock enable*/
__HAL_RCC_HSEM_CLK_ENABLE();
/*Take HSEM */
HAL_HSEM_FastTake(HSEM_ID_0);
/*Release HSEM in order to notify the CPU2(CM4)*/
HAL_HSEM_Release(HSEM_ID_0,0);
/* wait until CPU2 wakes up from stop mode */
timeout = 0xFFFF;
while((__HAL_RCC_GET_FLAG(RCC_FLAG_D2CKRDY) == RESET) && (timeout-- > 0));
```

## 4. 关键模块分析

### 4.1 内存扩展模块（SDRAM）

#### 功能概述
SDRAM模块用于扩展系统内存，提供32MB存储空间，主要用于图像数据缓存和大型数据处理。

#### 实现细节
- 基地址：0xC0000000
- 时钟频率：100MHz
- CAS延迟：3
- 通过FMC接口控制
- 支持字节和字读写测试

#### 关键函数
```c
void Ext_SDRAM_Init(void); // SDRAM初始化
uint32_t TestExtSDRAM(void); // SDRAM测试
```

### 4.2 外部存储模块（QSPI Flash）

#### 功能概述
QSPI Flash模块提供大容量非易失性存储，用于存储模型参数、配置数据和采集的传感器数据。

#### 实现细节
- 型号：W25Q256（32MB容量）
- 通过QSPI接口高速访问
- 支持页写、扇区擦除和高速读取
- 预留了Quad IO模式扩展接口

#### 关键函数
```c
void W25Q256JVFIQ_PageWrite(uint32_t address, uint8_t *data, uint32_t size);
void W25Q256JVFIQ_Read(uint32_t address, uint8_t *data, uint32_t size);
void W25Q256JVFIQ_EraseSector(uint32_t address);
```

### 4.3 图像采集模块（Camera）

#### 功能概述
摄像头模块使用OV2640图像传感器，通过DCMI接口实现高速图像采集，为计算机视觉应用提供原始图像数据。

#### 实现细节
- 传感器：OV2640
- 分辨率：160x120（可配置）
- 接口：DCMI（数据）+ I2C（控制）
- 支持自动曝光控制
- 数据格式：RAW格式

#### 关键函数
```c
void OV2640_Init(void); // 摄像头初始化
HAL_StatusTypeDef OV2640_WriteReg(uint8_t reg, uint8_t value); // 写寄存器
HAL_StatusTypeDef OV2640_ReadReg(uint8_t reg, uint8_t *value); // 读寄存器
```

### 4.4 音频采集模块（Microphone）

#### 功能概述
麦克风模块使用MP34DT06JTR数字麦克风，通过SAI接口采集PDM格式音频数据，并转换为PCM格式用于音频处理。

#### 实现细节
- 麦克风：MP34DT06JTR
- 接口：SAI（PDM模式）
- 支持PDM到PCM的实时转换
- 使用DMA进行高效数据传输

#### 关键函数
```c
void Start_PDM_Receive(void); // 开始PDM数据接收
void USER_PDM_Filter_Init(void); // 初始化PDM滤波器
void Process_PDM_To_PCM(void); // PDM转PCM处理
```

### 4.5 无线通信模块（WiFi）

#### 功能概述
WiFi模块提供无线通信能力，支持与上位机进行数据传输和远程控制。

#### 实现细节
- 接口：UART4
- 通信协议：AT指令集
- 支持Socket连接
- 配合调试控制台进行交互测试

### 4.6 内存性能测试模块

#### 功能概述
该模块用于测试不同类型内存（DTCM、SRAM、SDRAM）的读取延迟，为系统优化提供依据。

#### 实现细节
- 使用DWT（Data Watchpoint and Trace）计数器进行精确计时
- 测试迭代次数：1,000,000次
- 缓冲区大小：1KB
- 计算平均读取延迟（周期数和纳秒）

#### 关键函数
```c
void InitDWT(void); // 初始化DWT计数器
uint32_t GetDWT_CycleCount(void); // 获取当前周期计数
void TestMemoryLatency(void); // 内存延迟测试
```

## 5. 功能测试与验证

### 5.1 测试框架

项目采用模块化测试框架，通过宏定义控制各模块测试的启用/禁用：

```c
/*Module Test Switch*/
#define DBG_EXSDRAM_TEST 1
#define DBG_WIFI_TEST 1
#define DBG_QSPIFLASH_TEST 1
//#define DBG_CAMERADCMI_TEST 1
//#define DBG_MICROPHONE_TEST 1
#define DBG_MEMORY_LATENCY_TEST 1
```

### 5.2 测试结果分析

| 模块 | 测试内容 | 结果 | 说明 |
|------|---------|------|------|
| SDRAM | 单字节/字读写、批量读写 | 通过 | 验证了32MB扩展内存的正确性 |
| QSPI Flash | 页写、读取、扇区擦除 | 通过 | 验证了非易失性存储功能 |
| 摄像头 | ID读取、初始化 | 通过 | 设备识别成功，准备进行图像采集 |
| 内存性能 | DTCM/SRAM/SDRAM延迟对比 | 已实现 | 提供了精确的内存访问性能数据 |
| WiFi | AT指令测试、Socket通信 | 已实现 | 支持与上位机的无线通信 |

## 6. 技术亮点

### 6.1 高性能双核架构

项目充分利用STM32H7的双核优势，Cortex-M7负责主要的数据处理和算法执行，Cortex-M4负责辅助功能，实现了计算资源的高效分配。

### 6.2 丰富的传感器接口

集成了图像和音频两种关键传感器，为多模态TinyML应用提供了数据采集能力。

### 6.3 扩展内存系统

通过SDRAM和QSPI Flash的组合，解决了嵌入式设备内存受限的问题，为运行较大规模的神经网络模型提供了可能。

### 6.4 内存性能优化

实现了内存延迟测试工具，为系统优化和算法设计提供了性能参考数据，有助于开发者更好地理解和利用不同类型内存的特性。

### 6.5 CMSIS-NN支持

项目集成了CMSIS-NN库，为神经网络推理提供硬件加速支持，提高了TinyML模型的运行效率。

## 7. 应用场景与展望

### 7.1 潜在应用场景

- **智能视觉监控**：使用摄像头进行目标检测和识别
- **声音事件检测**：通过麦克风识别特定声音模式
- **环境监测**：结合多种传感器进行环境参数采集和分析
- **边缘AI计算**：在本地运行机器学习模型，减少云端依赖

### 7.2 未来优化方向

1. **完善传感器驱动**：完成摄像头和麦克风的完整功能实现
2. **优化双核协作**：更高效的任务分配和通信机制
3. **添加神经网络示例**：实现完整的TinyML应用案例
4. **低功耗设计**：优化系统功耗，延长电池供电时间
5. **扩展更多传感器**：支持环境、运动等更多类型的传感器

## 8. 总结

TinyMLPT项目成功构建了一个基于STM32H747I-Discovery的高性能TinyML开发平台，集成了丰富的硬件资源和软件功能。该平台不仅提供了完整的传感器数据采集能力，还通过内存扩展和双核架构支持复杂的机器学习算法运行。项目采用模块化设计，便于扩展和维护，为开发者提供了一个理想的TinyML应用开发和测试环境。

随着物联网和边缘计算的快速发展，TinyMLPT平台将在智能家居、工业监测、智能农业等领域发挥重要作用，推动AI技术向更广泛的终端设备普及。